---
title: "Chap 1.3 A Second Example"
author: "D Eddelbuettel"
date: "Friday, February 06, 2015"
output: html_document
---

This R Markdown document reproduces the example code in 
'Chapter 1: A Gental Introduction to Rcpp' of
*Seamless R and C++ Integration with Rcpp*
stored in the folder
"/SkyDrive/Trinostics/Rcpp Book".

```{r}
## parameter and error terms used throughout
a <- matrix(c(0.5,0.1,0.1,0.5),nrow=2)
u <- matrix(rnorm(10000),ncol=2)
## Let's start with the R version
rSim <- function(coeff, errors) {
  simdata <- matrix(0, nrow(errors), ncol(errors))
  for (row in 2:nrow(errors)) {
    simdata[row,] = coeff %*% simdata[(row-1),] + errors[row,]
  }
  return(simdata)
}
rData <- rSim(a, u) # generated by R
dim(rData)
matplot(rData[seq(from = 50, to = 5000, by = 100),], type = "l")
matplot(rData[1:100,], type = "l")
```

The same basic approach can be used with a C++function to 
generate the simulated VAR data. 
The next listing shows how to use **RcppArmadillo** via **inline** to compile,
link and load C++ code on the fly into your R session.

```{r}
## Now load 'inline' to compile C++ code on the fly
suppressMessages(require(inline))
code <- '
arma::mat coeff = Rcpp::as<arma::mat>(a);
arma::mat errors = Rcpp::as<arma::mat>(u);
int m = errors.n_rows;
int n = errors.n_cols;
arma::mat simdata(m,n);
simdata.row(0) = arma::zeros<arma::mat>(1,n);
for (int row=1; row<m; row++) {
  simdata.row(row) = simdata.row(row-1)*trans(coeff)
                     + errors.row(row);
}
return Rcpp::wrap(simdata);
'
## create the compiled function
rcppSim <- cxxfunction(signature(a = "numeric", u = "numeric"),
                       code, plugin = "RcppArmadillo")
rcppData <- rcppSim(a, u) # generated by C++ code
stopifnot(all.equal(rData, rcppData)) # checking results
```

#### 1.3.4 Comparison

```{r}
## now load the rbenchmark package and compare all three
suppressMessages(library(rbenchmark))
res <- benchmark(rcppSim(a, u),
                 rSim(a, u),
#                 compRsim(a, u),
                 columns=c("test", "replications", "elapsed",
                           "relative", "user.self", "sys.self"),
                 order="relative")
res
```

